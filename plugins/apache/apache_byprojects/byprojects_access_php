#!/usr/local/bin/php
<?php
/*
* munin_byprojects_access
*
* PHP script to monitor access *byprojects* (e.g. vhost) from multiple files and/or regex.
*
* Danny Fullerton <northox@mantor.org> 
* Mantor Organization <www.mantor.org>
* This work is licensed under a Creative Commons Attribution 3.0 Unported License.
*
* You need logtail (https://www.fourmilab.ch/webtools/logtail/)
*
* Log can be gather from multiple sources by simply specifying multiple log filename and/or an array with two
* elements: log filename and a regex.
*   - 'prod' => array('/home/prod/log/access.log'),
*     Prod graph will be using everything in /home/prod/log/access.log
*   - 'test' => array(array('/var/log/httpd/access.log', '"[A-Z]+ /test/'), '/home/test/log/access.log')
*     Test graph will be using eveything in /home/test/log/access.log and stuff that match '"[A-Z] /test/' in 
*     /var/log/httpd/access.log such as '"GET /test/'
*/

$server = 'Apache'; # define the web server in use
#$server = 'Nginx';

$statepath = '/usr/local/var/munin/plugin-state'; // where logtail will save the state
$logtail = '/usr/local/bin/logtail';

$logs = array(
'prod' => array('/home/prod/log/access.log'),
'test' => array(
                array('/var/log/httpd/access.log', '"[A-Z]+ /test/'),
                '/home/test/log/access.log'
          )
);

///////////////

if(isset($argv[1])) {
  if ($argv[1] == 'autoconf') {
    print "yes\n";
    exit(0);
  } elseif ($argv[1] == 'config') {
    $order = '';
    foreach($logs as $client => $files) $order .= $client.' ';
    print "graph_order $order\n";
    print "graph_title $server access byprojects\n";
    print "graph_total Total\n";
    print "graph_vlabel Access by \${graph_period}\n";
    print "graph_category $server\n";
    print "graph_info This graph show $server access by various projects.\n";
    foreach ($logs as $client => $files) {
      print $client.".label $client\n";
      print $client.".type DERIVE\n";
      print $client.".min 0\n";
    }
    exit(0);
  }
}

foreach ($logs as $client => $files) {
  $x = $i = 0;
  foreach ($files as $file) {
    $regex = null;
    $state = $statepath.'/'.$client.$x.'_access.state';
    if(is_array($file)) list($file, $regex) = $file;
    $h = popen("$logtail -f $file -o $state", 'r');
    while (!feof($h)) {
      $buf = fgets($h, 4096);
      if($buf == '') continue;
      if($regex === null || preg_match($regex, $buf)) {
        $i++;
      }
    }
    pclose($h);
    $x++;
  }
  print $client.".value $i\n";
}
?>
