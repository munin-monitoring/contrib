#!/bin/sh
# -*- sh -*-

# shellcheck disable=SC2046

: << =cut

=head1 NAME

cpu - Plugin to measure cpu on osx.

=head1 NOTES

This plugin runs the top command once per interval, to discover the current value of CPU usage on OSX.
The result is scaled to # of CPU's, so a 4 core machine will reach 400% utilization.
Contributions are welcome to convert the plugin to use a long running counter such as /proc/stat in Linux.

=head1 LICENSE

GPLv2

=head1 MAGIC MARKERS

 #%# family=auto
 #%# capabilities=autoconf

=cut

NCPU=$(sysctl hw.ncpu | cut -d" " -f2)

if [ "$1" = "autoconf" ]; then
        echo yes
        exit 0
fi

scaleto100=""

if [ "$1" = "config" ]; then
        # Linux had NCPU=$(egrep '^cpu[0-9]+ ' /proc/stat | wc -l)
        if [ "$scaleto100" = "yes" ]; then
                graphlimit=100
        else
                graphlimit=$(echo "$NCPU"*100 | bc)
        fi
        echo 'graph_title CPU usage'
        echo "graph_order system user idle"
        echo "graph_args --base 1000 -r --lower-limit 0 --upper-limit $graphlimit"
        echo 'graph_scale no'
        echo 'graph_vlabel %'
        echo 'graph_category system'
        echo 'system.label system'
        echo 'system.draw AREA'
        echo 'system.min 0'
        echo "system.info CPU time spent by the kernel in system activities"
        echo 'user.label user'
        echo 'user.draw STACK'
        echo 'user.min 0'
        echo 'user.info CPU time spent by normal programs and daemons'
        echo 'idle.label idle'
        echo 'idle.draw STACK'
        echo 'idle.min 0'
        echo 'idle.info Idle CPU time'

        exit 0
fi

# The second cpu reading is more accurate than the first, so "-l 2":
TOPINFO=$(top -l 2 | grep "CPU usage: " | tail -n 1)

CPU_USER=$(echo "$TOPINFO" | awk '/CPU usage: / { print substr($3, 1, length($3)-1) }')
CPU_SYS=$(echo "$TOPINFO" | awk '/CPU usage: / { print substr($5, 1, length($5)-1) }') 
CPU_IDLE=$(echo "$TOPINFO" | awk '/CPU usage: / { print substr($7, 1, length($7)-1) }') 
echo "system.value" $( echo "$NCPU"*"$CPU_SYS"/1 | bc)
echo "user.value" $( echo "$NCPU"*"$CPU_USER"/1 | bc)
echo "idle.value" $( echo "$NCPU"*"$CPU_IDLE"/1 | bc)
