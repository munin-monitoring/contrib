#!/usr/bin/env perl
# -*- perl -*-


# You need to have the Openfire "Load Statistic" Plugin-installed!


# [openfire_*]
# user root
# env.statsfile /var/log/openfire/stats.txt

# MAIN
use warnings;
use strict;
use File::Basename;

my $statsfile = ($ENV{'statsfile'} || '/usr/share/openfire/logs/stats.txt');

my $tailBin = "/usr/bin/tail";

# db,threads,tasks,sessions,nio,timestamp
my $type = basename($0);
$type =~ s/openfire_//;


if ( exists $ARGV[0] and $ARGV[0] eq "config" ) {
	if( $type eq "db" ) {
		print "graph_args --base 1000 -l 0\n";
		print "graph_title Openfire DB Usage\n";
		print "graph_vlabel Number of Connections\n";
		print "graph_category Openfire\n";
		print "graph_info The Graph shows Number of DB Connections\n";
		print "db_min.draw AREA\ndb_min.label min\ndb_min.type GAUGE\n";
		print "db_max.draw STACK\ndb_max.label max\ndb_max.type GAUGE\n";
		print "db_current.draw STACK\ndb_current.label current\ndb_current.type GAUGE\n";
		print "db_used.draw STACK\ndb_used.label used\ndb_used.type GAUGE\n";		
	}
	if( $type eq "threads" ) {
		print "graph_args --base 1000 -l 0\n";
		print "graph_scale no\n";		
		print "graph_title Openfire Threads\n";
		print "graph_vlabel Number of Threads\n";
		print "graph_category Openfire\n";
		print "graph_info The Graph shows Number of Threads\n";	
		print "thread_core.draw AREA\nthread_core.label Core Threads\nthread_core.type GAUGE\n";
		print "thread_active.draw STACK\nthread_active.label active Threads\nthread_active.type GAUGE\n";			
	}
	if( $type eq "tasks" ) {
		print "graph_args --base 1000 -l 0\n";
		print "graph_scale no\n";		
		print "graph_title Openfire Tasks\n";
		print "graph_vlabel Number of Tasks\n";
		print "graph_category Openfire\n";
		print "graph_info The Graph shows Number of Tasks\n";	
		print "task_queue.draw AREA\ntask_queue.label queued Tasks\ntask_queue.type GAUGE\n";
		print "task_completed.draw STACK\ntask_completed.label completed Tasks\ntask_completed.type GAUGE\n";		
	}
	if( $type eq "sessions" ) {
		print "graph_args --base 1000 -l 0\n";
		print "graph_scale no\n";		
		print "graph_title Openfire Sessions\n";
		print "graph_vlabel Number of Sessions\n";
		print "graph_category Openfire\n";
		print "graph_info The Graph shows Number of Jabber Sessions\n";
		print "sessions.label Jabber Sessions\nsessions.type GAUGE\n";
	}
	if( $type eq "nio" ) {
		print "graph_args --base 1000 -l 0\n";
		print "graph_title Openfire I/O (NIO)\n";
		print "graph_vlabel Number of Stanzas\n";
		print "graph_category Openfire\n";
		print "graph_info The Graph shows Number of Stanzas\n";
		print "nio_read.draw AREA\nnio_read.label Read\nnio_read.type GAUGE\n";
		print "nio_written.draw STACK\nnio_written.label Written\nnio_written.type GAUGE\n";	
		print "nio_queued_events.draw STACK\nnio_queued_events.label queued Events\nnio_queued_events.type GAUGE\n";	
		print "nio_queued_writes.draw STACK\nnio_queued_writes.label queued Writes\nnio_queued_writes.type GAUGE\n";					
	}
	if( $type eq "timestamp" ) {
		print "graph_args --base 1000 -l 0\n";	
		print "graph_title Openfire Log Timestamp\n";
		print "graph_vlabel Timestamp\n";
		print "graph_category Openfire\n";
		print "graph_info The Graph shows the Timestamp of the Log\n";
		print "timestamp.draw AREA\ntimestamp.label Log Timestamp\ntimestamp.type GAUGE\n";			
	}	
} else {
	my $cmd = "$tailBin -1 $statsfile";
	my $result = `$cmd`;
	my @array=split(/,/,$result);
	if( $type eq "timestamp" ) {
		print "timestamp.value $array[0]\n";
	}
	if( $type eq "db" ) {
		print "db_min.value $array[1]\n";
		print "db_max.value $array[2]\n";
		print "db_current.value $array[3]\n";
		print "db_used.value $array[4]\n";						
	}
	if( $type eq "threads" ) {
		print "thread_core.value $array[5]\n";
		print "thread_active.value $array[6]\n";
	}
	if( $type eq "tasks" ) {
		print "task_queue.value $array[7]\n";
		print "task_completed.value $array[8]\n";				
	}
	if( $type eq "sessions" ) {
		print "sessions.value $array[9]\n";
	}
	if( $type eq "nio" ) {
		print "nio_read.value $array[10]\n";
		print "nio_written.value $array[11]\n";
		print "nio_queued_events.value $array[12]\n";
		print "nio_queued_writes.value $array[13]";						
	}	
}