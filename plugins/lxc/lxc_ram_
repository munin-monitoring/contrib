#!/bin/bash
# -*- sh -*-

: << =cut

=head1 NAME

lxc_ram - Plugin to monitor LXC memory usage.

=head1 CONFIGURATION

  [lxc_*]
    user root

This is a wildcard plugin. To monitor memory usage for a LXC container,
link lxc_ram_<container> to this file. For example,

  ln -s /usr/share/munin/plugins/lxc_ram_ \
        /etc/munin/plugins/lxc_ram_mycontainer

will monitor the container "mycontainer".

=head1 INTERPRETATION

This plugin needs root privilege.

=head1 AUTHOR

vajtsz vajtsz@gmail.com
mitty   mitty@mitty.jp
Baptiste Jonglez

=head1 LICENSE

Unknown license

=head1 MAGIC MARKERS

 #%# family=auto
 #%# capabilities=autoconf suggest

=cut

. $MUNIN_LIBDIR/plugins/plugin.sh

CONTAINER="${0##*lxc_ram_}"

f_comm='lxc-cgroup  '

case $1 in
    autoconf)
	if [ -r /proc/stat ]; then
		echo yes
		exit 0
	else
		echo "no (no /proc/stat)"
		exit 0
	fi
        ;;
    suggest)
        lxc-ls -1
        exit 0
        ;;
    config)
        echo "graph_title Memory usage for LXC container $CONTAINER "
        echo 'graph_args -l 0 --base 1024'
        echo 'graph_vlabel byte'
        echo 'graph_category virtualization'
        echo 'graph_order mem_rss mem_kmem mem_cache mem_swap mem_usage mem_active mem_inactive'
        # Try to match colours with the official memory plugin
        echo 'mem_rss.label apps'
        echo 'mem_rss.type GAUGE'
        echo 'mem_rss.draw AREASTACK'
        echo 'mem_kmem.label kernel'
        echo 'mem_kmem.colour FFCC00' # Dark yellow
        echo 'mem_kmem.type GAUGE'
        echo 'mem_kmem.draw AREASTACK'
        echo 'mem_cache.label cache'
        echo 'mem_cache.colour 330099' # Dark blue
        echo 'mem_cache.type GAUGE'
        echo 'mem_cache.draw AREASTACK'
        echo 'mem_swap.label swap'
        echo 'mem_swap.colour FF0000' # Red
        echo 'mem_swap.type GAUGE'
        echo 'mem_swap.draw AREASTACK'
        echo 'mem_usage.label total mem'
        echo 'mem_usage.colour 000000' # Black
        echo 'mem_usage.type GAUGE'
        echo 'mem_active.label active'
        echo 'mem_active.colour B35A00' # Orange
        echo 'mem_active.type GAUGE'
        echo 'mem_active.draw LINE2'
        echo 'mem_inactive.label inactive'
        echo 'mem_inactive.colour B38F00' # Dark yellow
        echo 'mem_inactive.type GAUGE'
        echo 'mem_inactive.draw LINE2'
        exit 0
        ;;
esac

tmp_v=$($f_comm -n $CONTAINER memory.usage_in_bytes 2> /dev/null)
# Report an unknown value if the container is not currently running
[[ -z "$tmp_v" ]] && tmp_v='U'
echo 'mem_usage.value '$tmp_v

tmp_v=$($f_comm -n $CONTAINER memory.kmem.usage_in_bytes 2> /dev/null)
[[ -z "$tmp_v" ]] && tmp_v='U'
echo 'mem_kmem.value '$tmp_v

tmp_v=$($f_comm -n $CONTAINER memory.stat 2> /dev/null | grep total_cache | cut -d ' ' -f 2)
[[ -z "$tmp_v" ]] && tmp_v='U'
echo  'mem_cache.value '$tmp_v
   
tmp_v=$($f_comm -n $CONTAINER memory.stat 2> /dev/null | grep total_active_anon | cut -d ' ' -f 2)
[[ -z "$tmp_v" ]] && tmp_v='U'
echo  'mem_active.value '$tmp_v
   
tmp_v=$($f_comm -n $CONTAINER memory.stat 2> /dev/null | grep total_inactive_anon | cut -d ' ' -f 2)
[[ -z "$tmp_v" ]] && tmp_v='U'
echo  'mem_inactive.value '$tmp_v

tmp_v=$($f_comm -n $CONTAINER memory.stat 2> /dev/null | grep total_swap | cut -d ' ' -f 2)
[[ -z "$tmp_v" ]] && tmp_v='U'
echo  'mem_swap.value '$tmp_v

tmp_v=$($f_comm -n $CONTAINER memory.stat 2> /dev/null | grep '^rss ' | cut -d ' ' -f 2)
[[ -z "$tmp_v" ]] && tmp_v='U'
echo  'mem_rss.value '$tmp_v
