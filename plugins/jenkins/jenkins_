#!/usr/bin/env perl
# -*- perl -*-

=head1 NAME

jenkins_ - Plugin for displaying Jenkins Stats

=head1 INTERPRETATION

This plugin displays the following charts:

1) The Status of each Build
2) Number of Jobs in the Build Queue
3) Number of Builds, currently running

You can set the modes with naming the softlink:

1) jenkins_results
2) jenkins_queue
3) jenkins_running

=head1 CONFIGURATION

This plugin is configurable environment variables.

env.url 		Jenkins Host
env.port 		Jenkins Port
env.context		Jenkins Context path
env.user 		User for the API Tokent
env.apiToken 	Jenkins API Token (see https://wiki.jenkins-ci.org/display/JENKINS/Authenticating+scripted+clients)

Example:

[jenkins_*]
env.url localhost
env.port 4040
env.context /jenkins
env.user user
env.apiToken aaaa0f6e48b92cbbbbddecdb72dc1dad


=head1 AUTHOR

Philipp Haussleiter <philipp@haussleiter.de> (email)

=head1 LICENSE

GPLv2

=cut

# MAIN
use warnings;
use strict;
use JSON;
use File::Basename;

# VARS
my $url = ($ENV{'url'} || '10.10.10.104');
my $port = ($ENV{'port'} || '4040');
my $user = ($ENV{'user'} || '');
my $apiToken = ($ENV{'apiToken'} || '');
my $context = ($ENV{'context'} || '');
my $wgetBin = "/usr/bin/wget";

my $type = basename($0);
$type =~ s/jenkins_//;

my %states = ('blue' =>'stable', 'blue_anime' =>'stable', 'yellow'=>'unstable', 'yellow_anime'=>'unstable', 'red'=>'failing', 'red_anime'=>'failing', 'disabled'=>'disabled' );
my %counts = ('blue' => 0, 'yellow'=>0, 'red'=>0, 'disabled'=>0);

if ( exists $ARGV[0] and $ARGV[0] eq "config" ) {
	if( $type eq "results" ) {
    	print "graph_args --base 1000 -l 0\ngraph_title Jenkins Build Results\ngraph_vlabel Build Results\ngraph_category Jenkins\ngraph_info The Graph shows the Status of each Build\nbuild_disabled.draw AREA\nbuild_disabled.label disabled\nbuild_disabled.type GAUGE\nbuild_disabled.colour 8A8A8A\nbuild_failing.draw STACK\nbuild_failing.label failing\nbuild_failing.type GAUGE\nbuild_failing.colour E61217\nbuild_unstable.draw STACK\nbuild_unstable.label unstable\nbuild_unstable.type GAUGE\nbuild_unstable.colour F3E438\nbuild_stable.draw STACK\nbuild_stable.label stable\nbuild_stable.type GAUGE\nbuild_stable.colour 294D99\n"; 
        exit;
	}
	if( $type eq "queue" ) {
		print "graph_args --base 1000 -l 0\ngraph_title Jenkins Queue Length\ngraph_vlabel Number of Jobs in Queue\ngraph_category Jenkins\ngraph_info The Graph shows the Number of Jobs in the Build Queue\nbuild_count.label Jobs in Queue\nbuild_count.type GAUGE\n";
		exit;
	}
	if( $type eq "running" ) {
		print "graph_args --base 1000 -l 0\ngraph_title Jenkins Builds Running\ngraph_vlabel Builds currently running\ngraph_category Jenkins\ngraph_info The Graph shows the Number of Builds, currently running\nbuild_running.label running Builds\nbuild_running.type GAUGE\n";
		exit;
	}	
} else {
	# CODE
	my $auth = ( $user ne "" and $apiToken ne ""  ? " --auth-no-challenge --user=$user --password=$apiToken" : "" );
	my $cmd = "$wgetBin $auth -qO- $url:$port$context";  
	
	if( $type eq "results" ) {
		my $result = `$cmd/api/json`;
		my $parsed = decode_json($result);
		foreach my $cur(@{$parsed->{'jobs'}}) {
			$counts{$cur->{'color'}} += 1;
		}
		
		foreach my $status (keys %counts) {
			print "build_$states{$status}.value $counts{$status}\n";
		}
		exit;
	}
	
	if( $type eq "running" ) {
		my $count = 0;
		my $result = `$cmd/api/json`;
		my $parsed = decode_json($result);
		foreach my $cur(@{$parsed->{'jobs'}}) {
			if( $cur->{'color'} =~ /anime$/ ) {
				$count += 1;
			}
		}
		print "build_running.value ", $count, "\n";
		exit;	
	}
	
	if( $type eq "queue" ) {
		my $result = `$cmd/queue/api/json`;
		my $parsed = decode_json($result);	
		print "build_count.value ", scalar( @{$parsed->{'items'}} ), "\n";
		exit;
	}
}
