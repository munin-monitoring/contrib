#!/usr/bin/perl -w

=head1 NAME

Monitor CyberPower UPS Battery Status.


=head1 AUTHOR

Kai Boenke

=head1 LICENSE

Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)

=back


#####
# Enable SNMP-Discovery
###
=head1 MAGIC MARKERS
  #%# family=snmpauto
  #%# capabilities=snmpconf
=cut
if (defined $ARGV[0] and $ARGV[0] eq "snmpconf") {
	print "require 1.3.6.1.2.1.33.1.2.4.0\n";
	exit 0;
}


#####
# Initialize
###
use strict;
use Munin::Plugin::SNMP;
my $session	= Munin::Plugin::SNMP->session();


#####
# Declare OIDs
###
use constant oid_cps_battery_runtime	=> ".1.3.6.1.2.1.33.1.2.3.0";
use constant oid_cps_battery_charge	=> ".1.3.6.1.2.1.33.1.2.4.0";
use constant oid_cps_input_voltage	=> ".1.3.6.1.2.1.33.1.3.3.1.3.1";
use constant oid_cps_output_voltage	=> ".1.3.6.1.2.1.33.1.4.4.1.2.1";
use constant oid_cps_output_load	=> ".1.3.6.1.2.1.33.1.4.4.1.5.1";
use constant oid_cps_env_temp		=> ".1.3.6.1.4.1.3808.1.1.4.2.1.0";
use constant oid_cps_env_humidity	=> ".1.3.6.1.4.1.3808.1.1.4.3.1.0";


#####
# Config
###
if (defined $ARGV[0] and $ARGV[0] eq "config") {
	my ($host) = Munin::Plugin::SNMP->config_session();
	print "host_name $host\n" unless $host eq 'localhost';
	print "graph_title CyberPower UPS Environment
graph_info This graph shows environmental status information.
graph_category ups
graph_vlabel F/%
";
	print "temp.label Temperature
temp.draw LINE2
temp.type GAUGE
";
	print "humidity.label Humidity
humidity.draw LINE1
humidity.type GAUGE
humidity.min 0
humidity.max 100
";
	exit 0;
}


#####
# Get Values
###
my $temp	= $session->get_single(oid_cps_env_temp);
my $humidity	= $session->get_single(oid_cps_env_humidity);

if($temp ne 'U'){
	$temp /= 10;
	print "temp.value ", $temp, "\n";
}
if($humidity ne 'U'){
	print "humidity.value ", $humidity, "\n";
}
