#!/usr/bin/perl

use strict;
use warnings;
use Munin::Plugin::SNMP;
use vars qw($DEBUG);

$DEBUG = $ENV{'MUNIN_DEBUG'};

my %oids = (
        misc64NetRcvdBytes => 'NET_NETRCVDBYTES',
        misc64NetSentBytes => 'NET_NETSENTBYTES',
);

if (defined $ARGV[0] and $ARGV[0] eq 'snmpconf') {
    print "require 1.3.6.1.4.1.789.1.2.2.1.0 [0-9]\n";
    exit 0;
}

my $session = Munin::Plugin::SNMP->session();

if (defined $ARGV[0] and $ARGV[0] eq "config") {

    my ($host, undef, undef, undef) = Munin::Plugin::SNMP->config_session();

    print "host_name $host\n" unless $host eq 'localhost';
    print "graph_title $host Network interface traffic\n";
    print "graph_args --base 1000\n";
    print "graph_vlabel Bytes in (-) / out (+) per \${graph_period}\n";
    print "graph_category network\n";
    print "graph_info This graph shows net stats for the $host NetApp equipment.\n";
    print "graph_order misc64NetRcvdBytes misc64NetSentBytes\n";

    print "misc64NetRcvdBytes.type COUNTER\n";
    print "misc64NetRcvdBytes.min 0\n";
    print "misc64NetRcvdBytes.graph no\n";
    print "misc64NetRcvdBytes.label bps\n";

    print "misc64NetSentBytes.type COUNTER\n";
    print "misc64NetSentBytes.label bps\n";
    print "misc64NetSentBytes.min 0\n";
    print "misc64NetSentBytes.negative misc64NetRcvdBytes\n";
    print "misc64NetSentBytes.info misc64NetRcvdBytes/misc64NetSentBytes\n";

 exit 0;
}

my $values = $session->get_hash(
    -baseoid => '1.3.6.1.4.1.789.1.2.2',
    -cols    => {
        30  => 'misc64NetRcvdBytes',
        31  => 'misc64NetSentBytes',
    },
);

foreach my $k (keys %oids) {
    my $v = 'U';
    $v = $values->{0}->{$k} if (defined $values);
    print "$k.value $v\n";
}

exit 0;

__END__
