#!/usr/bin/perl
###############################################################################
#
#Munin plugin to monitor Ubiquiti AirOS device uptime.
#
#To use this plugin, copy it to the munin's plugin directory (eg. /usr/share/munin/plugins) 
#under the name "ubiu_". Don't change the filename.
#
#Then symlink it to munin's configured plugins directory (eg. /etc/munin/plugins) with names
#according to the devices you wish to monitor, like ubnt_apo.ubnt or ubnt_cli.ubnt
#
#In your /etc/hosts file, add to 127.0.0.1 some names which would corespond to your devices, eg:
#127.0.0.1              localhost       apo.ubnt        cli.ubnt
#
#Important: make sure to use the same names in your symlinks and other config places!
#
#In /etc/munin/plugin-conf.d/munin-node add the following, to be able to contact
#those devices via telnet (obviously replacing these with your own data):
#
#[ubiu_apo.ubnt]
#env.Name AccessPoint
#env.Host 192.168.2.2
#env.TelnetPort 23
#env.TelnetUser foobar
#env.TelnetPass raboof
#
#[ubiu_cli.ubnt]
#env.Name Client
#env.Host 192.168.2.3
#env.TelnetPort 23
#env.TelnetUser foobar
#env.TelnetPass raboof
#
#In /etc/munin/munin.conf add them as new virtual nodes:
#
#[apo.ubnt]
#    address 127.0.0.1
#
#[cli.ubnt]
#    address 127.0.0.1
#
#If all went well, you should by now have two additional nodes listed on the Web Interface of munin.
#
#Plugin base on aramsey's script, which is based on a MicroTik plugin, see for more info:
#http://community.ubnt.com/t5/NanoStation-and-Loco-Devices/SNMP-data-for-NF-dBm/m-p/39070/highlight/true#M11372
#
#Tested & working with munin v.2.0.14
###############################################################################
use diagnostics;
use Net::Telnet;
use strict;
use warnings;
##############################################################################
## Retrieve environmental variables
my $Name = $ENV{'Name'};
my $Host = $ENV{'Host'};
my $TelnetPort = $ENV{'TelnetPort'};
my $TelnetUser = $ENV{'TelnetUser'};
my $TelnetPass = $ENV{'TelnetPass'};

###############################################################################
## Determine Hostname
my $Hostname = undef;
$0 =~ /ubiu_(.+)*$/;
unless ($Hostname = $1) {
  exit 2;
}
###############################################################################
## Initiate Telnet Session
my $MT = Net::Telnet->new(Host    => $Host,
                                 Port    => $TelnetPort,
                                 Prompt  => '/ $/',
                                 Timeout => 30);

###############################################################################
## Configuration
if(exists $ARGV[0] and $ARGV[0] eq "config") {
  print "host_name " . $Hostname . "\n";
  print "graph_args --base 1000 -l 0 \n";
  print "graph_title " . $Name . " uptime\n";
  print "graph_vlabel uptime in days\n";
  print "graph_category Ubiquiti\n";
  print "graph_scale no\n";
  print "uptime.label uptime\n";
  print "uptime.draw AREA\n";
  exit;
}

###############################################################################
## Execution
if (!defined($MT->login($TelnetUser, $TelnetPass))) {
  die "Croaking: $MT->error";
} else {
  my @Output = $MT->cmd("cat /proc/uptime\nD\n");
  my ($uptime) = undef;
  foreach my $Line (@Output) {
    if ($Line !~ /XM.v/ && $Line =~ m/(\d+)/) {
      $uptime = $1 / 86400;
    }
  }
  print "uptime.value " . $uptime . "\n";
  exit;
}
