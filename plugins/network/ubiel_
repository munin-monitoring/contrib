#!/usr/bin/perl
###############################################################################
#
#Munin plugin to monitor Ubiquiti AirOS device LAN interface errors.
#
#To use this plugin, copy it to the munin's plugin directory (eg. /usr/share/munin/plugins) 
#under the name "ubiel_". Don't change the filename.
#
#Then symlink it to munin's configured plugins directory (eg. /etc/munin/plugins) with names
#according to the devices you wish to monitor, like ubnt_apo.ubnt or ubnt_cli.ubnt
#
#In your /etc/hosts file, add to 127.0.0.1 some names which would corespond to your devices, eg:
#127.0.0.1              localhost       apo.ubnt        cli.ubnt
#
#Important: make sure to use the same names in your symlinks and other config places!
#
#In /etc/munin/plugin-conf.d/munin-node add the following, to be able to contact
#those devices via telnet (obviously replacing these with your own data):
#
#[ubiel_apo.ubnt]
#env.Name AccessPoint
#env.Host 192.168.2.2
#env.TelnetPort 23
#env.TelnetUser foobar
#env.TelnetPass raboof
#
#[ubiel_cli.ubnt]
#env.Name Client
#env.Host 192.168.2.3
#env.TelnetPort 23
#env.TelnetUser foobar
#env.TelnetPass raboof
#
#In /etc/munin/munin.conf add them as new virtual nodes:
#
#[apo.ubnt]
#    address 127.0.0.1
#
#[cli.ubnt]
#    address 127.0.0.1
#
#If all went well, you should by now have two additional nodes listed on the Web Interface of munin.
#
#Plugin base on aramsey's script, which is based on a MicroTik plugin, see for more info:
#http://community.ubnt.com/t5/NanoStation-and-Loco-Devices/SNMP-data-for-NF-dBm/m-p/39070/highlight/true#M11372
#
#Tested & working with munin v.2.0.14
###############################################################################
use diagnostics;
use Net::Telnet;
use strict;
use warnings;
##############################################################################
## Retrieve environmental variables
my $Name = $ENV{'Name'};
my $Host = $ENV{'Host'};
my $TelnetPort = $ENV{'TelnetPort'};
my $TelnetUser = $ENV{'TelnetUser'};
my $TelnetPass = $ENV{'TelnetPass'};
my $graph_period = $ENV{'graph_period'};

###############################################################################
## Determine Hostname
my $Hostname = undef;
$0 =~ /ubiel_(.+)*$/;
unless ($Hostname = $1) {
  exit 2;
}
###############################################################################
## Initiate Telnet Session
my $MT = Net::Telnet->new(Host    => $Host,
                                 Port    => $TelnetPort,
                                 Prompt  => '/ $/',
                                 Timeout => 30);

###############################################################################
## Configuration
if(exists $ARGV[0] and $ARGV[0] eq "config") {
  print "graph_order rcvd trans\n";
  print "graph_args --base 1000\n";
  print "graph_vlabel packets in (-) / out (+) per " . $graph_period . "\n";
  print "graph_info This graph shows the amount of errors, packet drops, and collisions on the LAN network interface.\n";
  print "rcvd.label errors\n";
  print "rcvd.type COUNTER\n";
  print "rcvd.graph no\n";
  print "rcvd.warning 1\n";
  print "trans.label errors\n";
  print "trans.type COUNTER\n";
  print "trans.negative rcvd\n";
  print "trans.warning 1\n";
  print "host_name " . $Hostname . "\n";
  print "graph_title " . $Name . " LAN errors\n";
  print "graph_category Ubiquiti\n";

  exit;
}

###############################################################################
## Execution
if (!defined($MT->login($TelnetUser, $TelnetPass))) {
  die "Croaking: $MT->error";
} else {
  my @Output = $MT->cmd("ubntbox mca-status\n");
  my ($rcvd, $trans) = undef;
  foreach my $Line (@Output) {
    if ($Line =~ /lanRxErrors/ && $Line !~ /wlan/ && $Line =~ m/(.\d+)/) {
        $rcvd = substr($Line, 12,2);
    }
    if ($Line =~ /lanTxErrors/ && $Line !~ /wlan/ && $Line =~ m/(.\d+)/) {
  $trans = substr($Line, 12,2);
    }
  }
  print "rcvd.value " . $rcvd . "\n";
  print "trans.value " . $trans . "\n";
  exit;
}
