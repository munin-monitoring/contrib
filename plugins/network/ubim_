#!/usr/bin/perl
###############################################################################
#
#Munin plugin to monitor Ubiquiti AirOS device memory status.
#
#To use this plugin, copy it to the munin's plugin directory (eg. /usr/share/munin/plugins) 
#under the name "ubim_". Don't change the filename.
#
#Then symlink it to munin's configured plugins directory (eg. /etc/munin/plugins) with names
#according to the devices you wish to monitor, like ubnt_apo.ubnt or ubnt_cli.ubnt
#
#In your /etc/hosts file, add to 127.0.0.1 some names which would corespond to your devices, eg:
#127.0.0.1              localhost       apo.ubnt        cli.ubnt
#
#Important: make sure to use the same names in your symlinks and other config places!
#
#In /etc/munin/plugin-conf.d/munin-node add the following, to be able to contact
#those devices via telnet (obviously replacing these with your own data):
#
#[ubim_apo.ubnt]
#env.Name AccessPoint
#env.Host 192.168.2.2
#env.TelnetPort 23
#env.TelnetUser foobar
#env.TelnetPass raboof
#
#[ubim_cli.ubnt]
#env.Name Client
#env.Host 192.168.2.3
#env.TelnetPort 23
#env.TelnetUser foobar
#env.TelnetPass raboof
#
#In /etc/munin/munin.conf add them as new virtual nodes:
#
#[apo.ubnt]
#    address 127.0.0.1
#
#[cli.ubnt]
#    address 127.0.0.1
#
#If all went well, you should by now have two additional nodes listed on the Web Interface of munin.
#
#Plugin base on aramsey's script, which is based on a MicroTik plugin, see for more info:
#http://community.ubnt.com/t5/NanoStation-and-Loco-Devices/SNMP-data-for-NF-dBm/m-p/39070/highlight/true#M11372
#
#Tested & working with munin v.2.0.14
###############################################################################
use diagnostics;
use Net::Telnet;
use strict;
use warnings;
##############################################################################
## Retrieve environmental variables
my $Name = $ENV{'Name'};
my $Host = $ENV{'Host'};
my $TelnetPort = $ENV{'TelnetPort'};
my $TelnetUser = $ENV{'TelnetUser'};
my $TelnetPass = $ENV{'TelnetPass'};

###############################################################################
## Determine Hostname
my $Hostname = undef;
$0 =~ /ubim_(.+)*$/;
unless ($Hostname = $1) {
  exit 2;
}
###############################################################################
## Initiate Telnet Session
my $MT = Net::Telnet->new(Host    => $Host,
                                 Port    => $TelnetPort,
                                 Prompt  => '/ $/',
                                 Timeout => 30);

###############################################################################
## Configuration
if(exists $ARGV[0] and $ARGV[0] eq "config") {
  print "host_name " . $Hostname . "\n";
  print "graph_args -l 0 \n";
  print "graph_title " . $Name . " memory\n";
  print "graph_vlabel kB\n";
  print "graph_category Ubiquiti\n";
  print "graph_info This graph shows the device memory status\n";
  print "memTotal.label Total\n";
  print "memFree.label Free\n";
  print "memBuffers.label Buffers\n";
  exit;
}

###############################################################################
## Execution
if (!defined($MT->login($TelnetUser, $TelnetPass))) {
  die "Croaking: $MT->error";
} else {
  my @Output = $MT->cmd("ubntbox mca-status\n");
  my ($mt, $mf, $mb) = undef;
  foreach my $Line (@Output) {
    if ($Line =~ /memTotal/ && $Line =~ m/(\d+)/) {
      $mt = $1;
    }
    if ($Line =~ /memFree/ && $Line =~ m/(\d+)/) {
      $mf = $1;
    }
    if ($Line =~ /memBuffers/ && $Line =~ m/(\d+)/) {
      $mb = $1;
    }
  }
  print "memTotal.value " . $mt . "\n";
  print "memFree.value " . $mf . "\n";
  print "memBuffers.value " . $mb . "\n";
  exit;
}
